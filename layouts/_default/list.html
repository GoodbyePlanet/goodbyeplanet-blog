{{ define "main" }}
<main id="main">
    <h1>{{ .Title }}</h1>
    {{ if site.Params.search }}
    <input
            id="search"
            type="text"
            placeholder="{{ T " search_placeholder" }}"
    aria-label="{{ T "search_aria_label" }}"
    />
    {{ end }}

    {{ $tag := .Title }}
    {{ $filteredPages := where .Site.RegularPages "Type" "in" (slice "post") }}

    {{ if and $tag (ne $tag "Blog") }}
    {{ $filteredPages = where $filteredPages "Params.tags" "intersect" (slice $tag) }}
    {{ end }}

    <div class="posts-grid">
        {{ range $filteredPages.ByPublishDate.Reverse }}
        <article class="post-card">
            <a href="{{ .RelPermalink }}">
                <div class="post-image">
                    {{ $image := .Resources.GetMatch "featured-image*" }}
                    {{ if not $image }}
                    {{ $image = .Resources.GetMatch "{*.jpg,*.png,*.webp}" }}
                    {{ end }}

                    {{ with $image }}
                    {{/* Process image: Resize to max 600px width and convert to WebP */}}
                    {{ $processed := .Resize "600x webp" }}
                    <img
                            src="{{ $processed.RelPermalink }}"
                            width="{{ $processed.Width }}"
                            height="{{ $processed.Height }}"
                            alt="{{ $.Title }}"
                            loading="lazy"
                            decoding="async"
                    >
                    {{ else }}
                    <div class="placeholder-image"></div>
                    {{ end }}
                </div>
                <div class="post-content">
                    <h2 class="post-title">{{ .Title }}</h2>
                    <time class="post-date">Updated: {{ .Lastmod.Format "2 Jan, 2006" }}</time>
                </div>
            </a>
        </article>
        {{ end }}
    </div>
</main>
{{ end }}